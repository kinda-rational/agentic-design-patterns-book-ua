# Розділ 13: Людина в контурі

Паттерн Human-in-the-Loop (HITL) представляє ключову стратегію у розробці та розгортанні агентів. Він навмисне переплітає унікальні сильні сторони людського пізнання — такі як судження, креативність та нюансоване розуміння — з обчислювальною потужністю та ефективністю ШІ. Ця стратегічна інтеграція є не просто опцією, але часто необхідністю, особливо коли системи ШІ все більше вбудовуються у критичні процеси прийняття рішень.

Основний принцип HITL полягає у забезпеченні того, щоб ШІ працював у межах етичних кордонів, дотримувався протоколів безпеки та досягав своїх цілей з оптимальною ефективністю. Ці проблеми особливо гострі в областях, які характеризуються складністю, неоднозначністю або значним ризиком, де наслідки помилок чи неправильних інтерпретацій ШІ можуть бути суттєвими. У таких сценаріях повна автономія — коли системи ШІ функціонують незалежно без якого-небудь людського втручання — може виявитися недальновидною. HITL визнає цю реальність та підкреслює, що навіть при швидко розвивальних технологіях ШІ людський нагляд, стратегічний внесок та спільні взаємодії залишаються незамінними.

Підхід HITL в основному обертається навколо ідеї синергії між штучним та людським інтелектом. Замість того, щоб розглядати ШІ як заміну людським працівникам, HITL позиціонує ШІ як інструмент, який доповнює та розширює людські можливості. Це доповнення може приймати різні форми: від автоматизації рутинних завдань до надання засобів розуміння інсайтів, які інформують людські рішення. Кінцева мета полягає у створенні спільної екосистеми, де й люди, й агенти ШІ можуть використовувати свої відмінні сильні сторони для досягнення результатів, яких жодна з них не могла б досягти самостійно.

На практиці HITL може бути реалізований різними способами. Один поширений підхід включає людей, які виступають як валідатори чи рецензенти, що розглядають вихідні дані ШІ для забезпечення точності та виявлення потенційних помилок. Інша реалізація включає людей, які активно спрямовують поведінку ШІ, надаючи зворотний зв'язок чи вносячи виправлення в реальному часі. У більш складних установках люди можуть співпрацювати з ШІ як партнери, спільно розв'язуючи проблеми чи приймаючи рішення через інтерактивний діалог чи спільні інтерфейси. Незалежно від конкретної реалізації, паттерн HITL підкреслює важливість збереження людського контролю та нагляду, забезпечуючи, що системи ШІ залишаються узгодженими з людською етикою, цінностями, цілями та суспільними очікуваннями.

## Огляд паттерну Human-in-the-Loop

Паттерн Human-in-the-Loop (HITL) інтегрує штучний інтелект з людським внеском для поліпшення можливостей агентів. Цей підхід визнає, що оптимальна продуктивність ШІ часто вимагає комбінації автоматизованої обробки та людського розуміння, особливо у сценаріях з високою складністю чи етичними міркуваннями. Замість заміни людського внеску, HITL прагне доповнити людські здібності, забезпечуючи, щоб критичні судження та рішення були засновані на людському розумінні.

HITL охоплює кілька ключових аспектів: Людський нагляд, який включає моніторинг продуктивності та вихідних даних агента ШІ (наприклад, через огляд логів чи дашборди в реальному часі) для забезпечення дотримання рекомендацій та запобігання небажаним результатам. Втручання та корекція відбуваються, коли агент ШІ зіткнеться з помилками чи неоднозначними сценаріями та може запросити людське втручання; людські оператори можуть виправити помилки, надати відсутні дані чи спрямувати агента, що також інформує про майбутні поліпшення агента. Людський зворотний зв'язок для навчання збирається та використовується для поліпшення моделей ШІ, особливо у методологіях, таких як навчання з підкріпленням з людським зворотним зв'язком, де людські переваги безпосередньо впливають на траєкторію навчання агента. Доповнення рішень - це коли агент ШІ надає анали та рекомендації людині, яка потім приймає остаточне рішення, покращуючи прийняття людських рішень через інсайти, генеровані ШІ, а не повну автономію. Співпраця людини та агента - це спільна взаємодія, де люди та агенти ШІ вносять свої відповідні сильні сторони; рутинна обробка даних може обробляватися агентом, тоді як творче розв'язування проблем чи складні переговори керуються людиною. Нарешті, політики підвищення - це встановлені протоколи, які диктують, коли та як агент повинен підвищити завдання людським операторам, запобігаючи помилкам у ситуаціях, що виходять за межі можливостей агента.

Впровадження паттернів HITL дозволяє використовувати агентів у чутливих секторах, де повна автономія неможлива чи недозволена. Це також надає механізм для постійного поліпшення через цикли зворотного зв'язку. Наприклад, у фінансах остаточне одобрення великого корпоративного кредиту вимагає, щоб людина-кредитний спеціаліст оцінив якісні фактори, такі як характер управління. Подібно до цього, у юридичній сфері основні принципи справедливості та підзвітності вимагають, щоб людина-суддя зберегла остаточну владу над критичними рішеннями, такими як винесення вироку, які включають складне моральне рассудження.

### Застереження

Незважаючи на свої переваги, паттерн HITL має значні застереження, головним з яких є відсутність масштабованості. Хоча людський нагляд забезпечує високу точність, оператори не можуть керувати мільйонами завдань, створюючи фундаментальний компроміс, який часто вимагає гібридного підходу, що поєднує автоматизацію для масштабу та HITL для точності. Крім того, ефективність цього паттерну сильно залежить від експертизи людських операторів; наприклад, хоча ШІ може генерувати програмний код, тільки досвідчений розробник може точно виявити тонкі помилки та надати правильне керівництво для їх виправлення. Ця потреба в експертизі також застосовується при використанні HITL для генерування тренувальних даних, оскільки людські анотатори можуть потребувати спеціального навчання, щоб навчитися коригувати ШІ таким чином, який виробляє високоякісні дані. Нарешті, впровадження HITL порушує значні проблеми конфіденційності, оскільки чутливу інформацію часто потрібно ретельно дезідентифікувати, перш ніж вона може бути розкрита людському оператору, додаючи ще один рівень складності процесу.

## Практичні застосування та випадки використання

Паттерн Human-in-the-Loop є життєво важливим у широкому спектрі галузей та застосувань, особливо там, де точність, безпека, етика чи нюансоване розуміння мають першорядне значення.

- **Модерація контенту:** Агенти ШІ можуть швидко фільтрувати величезні обсяги онлайн-контенту на предмет порушень (наприклад, мова ненависті, спам). Однак неоднозначні випадки чи граничний контент підвищуються до людських модераторів для огляду та остаточного рішення, забезпечуючи нюансоване судження та дотримання складної політики.

- **Автономне керування:** Хоча самокеровані автомобілі справляються з більшістю завдань керування автономно, вони розроблені для передачі управління людині-водієві у складних, непередбачуваних чи небезпечних ситуаціях, з якими ШІ не може впевнено справиться (наприклад, екстремальні погодні умови, незвичайні умови дороги).

- **Виявлення фінансового шахрайства:** Системи ШІ можуть позначити підозрілі операції на основі паттернів. Однак високоризиковані чи неоднозначні сигнали часто відправляються людським аналітикам, які проводять подальше розслідування, зв'язуються з клієнтами та приймають остаточне визначення щодо того, чи є операція шахрайством.

- **Огляд юридичних документів:** ШІ може швидко сканувати та категоризувати тисячі юридичних документів для виявлення релевантних положень чи доказів. Людські юридичні професіонали потім переглядають висновки ШІ на точність, контекст та юридичні наслідки, особливо для критичних справ.

- **Підтримка клієнтів (складні запити):** Чат-бот може обробляти рутинні запити клієнтів. Якщо проблема користувача занадто складна, емоційно заряджена або вимагає співчуття, яке ШІ не може надати, розмова плавно передається людському агентові підтримки.

- **Розмітка та анотація даних:** Моделі ШІ часто потребують великих наборів розмічених даних для тренування. Люди включаються в контур для точної розмітки зображень, тексту чи аудіо, надаючи істинні дані, на яких вчиться ШІ. Це постійний процес з розвитком моделей.

- **Поліпшення генеративного ШІ:** Коли LLM генерує креативний контент (наприклад, тексти маркетингу, дизайнерські ідеї), людські редактори чи дизайнери переглядають та поліпшують результати, забезпечуючи дотримання рекомендацій бренду, резонанс з цільовою аудиторією та збереження якості.

- **Автономні мережі:** Системи ШІ здатні аналізувати оповіщення та прогнозувати мережеві проблеми та аномалії трафіку, використовуючи ключові показники продуктивності (KPI) та виявлені паттерни. Проте критичні рішення — такі як усунення високоризикових оповіщень — часто підвищуються до людських аналітиків. Ці аналітики проводять подальше розслідування та приймають остаточне визначення щодо одобрення змін у мережі.

Цей паттерн демонструє практичний метод для впровадження ШІ. Він використовує ШІ для підвищення масштабованості та ефективності, зберігаючи людський нагляд для забезпечення якості, безпеки та етичної узгодженості.

"Human-on-the-loop" — це варіація цього паттерну, де людські експерти визначають загальну політику, а ШІ потім обробляє негайні дії для забезпечення дотримання. Розглянемо два приклади:

- **Автоматизована система фінансової торгівлі:** У цьому сценарії людина-фінансовий експерт встановлює загальну інвестиційну стратегію та правила. Наприклад, людина може визначити політику як: "Підтримувати портфель з 70% технологічних акцій та 30% облігацій, не інвестувати більше 5% у будь-яку окрему компанію та автоматично продавати будь-яку акцію, яка падає на 10% нижче ціни покупки." ШІ потім моніторить фондовий ринок у реальному часі, негайно виконуючи угоди, коли ці попередньо визначені умови виконуються. ШІ обробляє негайні високошвидкісні дії на основі повільнішої, більш стратегічної політики, встановленої людським оператором.

- **Сучасний колл-центр:** У цій установці людина-менеджер встановлює високорівневі політики для взаємодій з клієнтами. Наприклад, менеджер може встановити правила, такі як "будь-який дзвінок, що згадує 'відключення послуги', повинен бути негайно спрямований спеціалісту технічної підтримки" або "якщо тон голосу клієнта указує на високе розчарування, система повинна запропонувати підключити його безпосередньо до людського агента." Система ШІ потім обробляє початкові взаємодії з клієнтами, слухаючи та інтерпретуючи їхні потреби в реальному часі. Вона автономно виконує політики менеджера, негайно спрямовуючи дзвінки чи пропонуючи підвищення без потреби у людському втручанні для кожного окремого випадку. Це дозволяє ШІ керувати великим обсягом негайних дій у відповідності з повільнішим, стратегічним керівництвом, наданим людським оператором.

## Практичний приклад коду

Для демонстрації паттерну Human-in-the-Loop агент ADK може виявляти сценарії, що вимагають людського огляду, та ініціювати процес підвищення. Це дозволяє людське втручання у ситуаціях, де можливості автономного прийняття рішень агента обмежені або коли потрібні складні судження. Це не ізольована функція; інші популярні фреймворки прийняли подібні можливості. LangChain, наприклад, також надає інструменти для впровадження цих типів взаємодій.

```python
from google.adk.agents import Agent
from google.adk.tools.tool_context import ToolContext
from google.adk.callbacks import CallbackContext
from google.adk.models.llm import LlmRequest
from google.genai import types
from typing import Optional


# Заглушки для інструментів (замініть на реальні впровадження при необхідності)
def troubleshoot_issue(issue: str) -> dict:
    """Діагностує технічну проблему."""
    return {
        "status": "success",
        "report": f"Кроки діагностики для {issue}."
    }


def create_ticket(issue_type: str, details: str) -> dict:
    """Створює тикет підтримки."""
    return {
        "status": "success",
        "ticket_id": "TICKET123"
    }


def escalate_to_human(issue_type: str) -> dict:
    """Підвищує проблему до людини-спеціаліста."""
    # У реальній системі це зазвичай передає у чергу людини
    return {
        "status": "success",
        "message": f"Підвищено {issue_type} до людини-спеціаліста."
    }


technical_support_agent = Agent(
    name="technical_support_specialist",
    model="gemini-2.0-flash-exp",
    instruction="""
Ви спеціаліст технічної підтримки нашої електронної компанії.
СПОЧАТКУ перевірте, чи у користувача є історія підтримки в state["customer_info"]["support_history"].
Якщо є, посилайтеся на цю історію у своїх відповідях.

Для технічних проблем:
1. Використовуйте інструмент troubleshoot_issue для аналізу проблеми.
2. Проведіть користувача через базові кроки діагностики.
3. Якщо проблема зберігається, використовуйте create_ticket для реєстрації проблеми.

Для складних проблем, що виходять за межі базової діагностики:
1. Використовуйте escalate_to_human для передачі до людини-спеціаліста.

Підтримуйте професійний, але співчутливий тон. Визнавайте розчарування, яке можуть
викликати технічні проблеми, надаючи чіткі кроки до розв'язання.
""",
    tools=[troubleshoot_issue, create_ticket, escalate_to_human]
)


def personalization_callback(
    callback_context: CallbackContext, llm_request: LlmRequest
) -> Optional[LlmRequest]:
    """Додає інформацію про персоналізацію до запиту LLM."""
    # Отримуємо інформацію про клієнта зі стану
    customer_info = callback_context.state.get("customer_info")
    if customer_info:
        customer_name = customer_info.get("name", "шановний клієнте")
        customer_tier = customer_info.get("tier", "стандартний")
        recent_purchases = customer_info.get("recent_purchases", [])

        personalization_note = (
            f"\nВАЖЛИВА ПЕРСОНАЛІЗАЦІЯ:\n"
            f"Ім'я клієнта: {customer_name}\n"
            f"Рівень клієнта: {customer_tier}\n"
        )
        if recent_purchases:
            personalization_note += (
                f"Недавні покупки: {', '.join(recent_purchases)}\n"
            )

        if llm_request.contents:
            # Додаємо як системне повідомлення перед першим контентом
            system_content = types.Content(
                role="system",
                parts=[types.Part(text=personalization_note)]
            )
            llm_request.contents.insert(0, system_content)

    return None  # Повертаємо None для продовження з модифікованим запитом
```

Цей код пропонує схему для створення агента технічної підтримки, використовуючи Google ADK, розроблену навколо фреймворку HITL. Агент діє як інтелектуальна перша лінія підтримки, налаштована з конкретними інструкціями та озброєна інструментами, такими як `troubleshoot_issue`, `create_ticket` та `escalate_to_human`, для керування повним робочим процесом підтримки. Інструмент підвищення є основною частиною дизайну HITL, забезпечуючи передачу складних чи чутливих випадків людським спеціалістам.

Ключова особливість цієї архітектури — її здатність до глибокої персоналізації, досягнута через спеціальну функцію зворотного виклику. Перед звернення до LLM ця функція динамічно витягує специфічні для клієнта дані — такі як їхнє ім'я, рівень та історія покупок — зі стану агента. Цей контекст потім вбудовується в промпт як системне повідомлення, дозволяючи агентові надавати вищі адаптовані та інформовані відповіді, які посилаються на історію користувача. Поєднуючи структурований робочий процес з важливим людським наглядом та динамічною персоналізацією, цей код служить практичним прикладом того, як ADK полегшує розробку складних та надійних рішень підтримки ШІ.

## З першого погляду

**Що:** Системи ШІ, включаючи передові LLM, часто мають труднощі з завданнями, що вимагають нюансованого судження, етичного рассудження чи глибокого розуміння складних, неоднозначних контекстів. Розгортання повністю автономного ШІ у високоризикових середовищах несе значні ризики, оскільки помилки можуть призвести до серйозних наслідків для безпеки, фінансів чи етики. Ці системи не мають притаманної людям креативності та здорового глузду. Отже, покладатися виключно на автоматизацію у критичних процесах прийняття рішень часто недальновидно та може підірвати загальну ефективність та надійність системи.

**Чому:** Паттерн Human-in-the-Loop (HITL) надає стандартизоване рішення шляхом стратегічної інтеграції людського нагляду у робочі процеси ШІ. Цей агентний підхід створює симбіотичне партнерство, де ШІ обробляє важку обчислювальну роботу та обробку даних, тоді як люди забезпечують критичну валідацію, зворотний зв'язок та втручання. Таким чином, HITL гарантує, що дії ШІ узгоджуються з людськими цінностями та протоколами безпеки. Ця спільна структура не лише пом'якшує ризики повної автоматизації, але й поліпшує можливості системи через постійне навчання з людського внеску. Зрештою це призводить до більш надійних, точних та етичних результатів, яких ні людина, ні ШІ не змогли б досягти самостійно.

**Емпіричне правило:** Використовуйте цей паттерн при розгортанні ШІ у областях, де помилки мають суттєві наслідки для безпеки, етики або фінансів, таких як охорона здоров'я, фінанси чи автономні системи. Він необхідний для завдань, що включають неоднозначність та нюанси, які LLM не можуть надійно обробити, таких як модерація контенту чи складні підвищення підтримки клієнтів. Застосовуйте HITL, коли метою є постійне поліпшення моделі ШІ з високоякісними, розміченими людиною даними, або для поліпшення результатів генеративного ШІ для дотримання специфічних стандартів якості.

**Візуальне резюме:**

![][image1]

_Рис.1: Паттерн проектування Human in the loop_

## Ключові висновки

Ключові висновки включають:

- Human-in-the-Loop (HITL) інтегрує людський інтелект та судження у робочі процеси ШІ.
- Він критично важливий для безпеки, етики та ефективності у складних або високоризикових сценаріях.
- Ключові аспекти включають людський нагляд, втручання, зворотний зв'язок для навчання та доповнення рішень.
- Політики підвищення необхідні для агентів, щоб знати, коли передати управління людині.
- HITL дозволяє відповідальне розгортання ШІ та постійне поліпшення.
- Основними недоліками Human-in-the-Loop є його притаманна відсутність масштабованості, яка створює компроміс між точністю та обсягом, та його залежність від висококваліфікованих експертів предметної галузі для ефективного втручання.
- Його впровадження представляє операційні виклики, включаючи потребу у навчанні людських операторів для генерування даних та розв'язування проблем конфіденційності шляхом дезідентифікації чутливої інформації.

## Висновок

Цей розділ досліджував життєво важливий паттерн Human-in-the-Loop (HITL), підкреслюючи його роль у створенні надійних, безпечних та етичних систем ШІ. Ми обговорили, як інтеграція людського нагляду, втручання та зворотного зв'язку у робочі процеси агентів може значно поліпшити їхню продуктивність та надійність, особливо у складних та чутливих областях. Практичні застосування продемонстрували широку корисність HITL, від модерації контенту та медичної діагностики до автономного керування та підтримки клієнтів. Концептуальний приклад коду надав розуміння того, як ADK може полегшити ці взаємодії людини та агента через механізми підвищення. Оскільки можливості ШІ продовжують розвиватися, HITL залишається наріжним каменем для відповідальної розробки ШІ, гарантуючи, що людські цінності та експертиза залишаються центральними у дизайні інтелектуальних систем.

## Література

1. A Survey of Human-in-the-loop for Machine Learning, Xingjiao Wu, Luwei Xiao, Yixuan Sun, Junhang Zhang, Tianlong Ma, Liang He, [https://arxiv.org/abs/2108.00941](https://arxiv.org/abs/2108.00941)

[image1]: ../Assets/chapter-13-image1.png

---

## Навігація

**Назад:** [Розділ 12. Обробка винятків та відновлення](Розділ%2012.%20Обробка%20винятків%20та%20відновлення.md)
**Вперед:** [Розділ 14. Вилучення знань](Розділ%2014.%20Вилучення%20знань.md)
