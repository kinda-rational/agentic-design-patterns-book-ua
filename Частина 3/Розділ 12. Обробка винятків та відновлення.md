# Розділ 12: Обробка винятків та відновлення

Щоб агенти ШІ могли надійно працювати в різноманітних реальних середовищах, вони повинні вміти справлятися з непередбаченими ситуаціями, помилками та збоями. Так само як люди адаптуються до неочікуваних перешкод, інтелектуальні агенти потребують надійних систем для виявлення проблем, ініціювання процедур відновлення або, як мінімум, забезпечення контрольованого відмови. Ця важлива потреба формує основу паттерну обробки винятків та відновлення.

Цей паттерн фокусується на розробці виключно стійких агентів, які можуть підтримувати безперервну функціональність та операційну цілісність, незважаючи на різноманітні труднощі та аномалії. Він підкреслює важливість як проактивної підготовки, так і реактивних стратегій для забезпечення безперервної роботи навіть при зіткненні з викликами. Ця адаптивність критично важлива для успішної функціональності агентів у складних та непередбачуваних умовах, в кінцевому рахунку підвищуючи їх загальну ефективність та надійність.

Здатність справлятися з непередбаченими подіями гарантує, що ці системи ШІ є не тільки інтелектуальними, але й стабільними та надійними, що сприяє більшій довірі до їх розгортання та продуктивності. Інтеграція комплексних інструментів моніторингу та діагностики додатково підсилює здатність агента швидко виявляти та усувати проблеми, запобігаючи потенційним порушенням та забезпечуючи більш плавну роботу в змінних умовах. Ці передові системи мають вирішальне значення для збереження цілісності та ефективності операцій ШІ, підсилюючи їх здатність керувати складністю та непередбачуваністю.

Цей паттерн іноді може використовуватися спільно з рефлексією. Наприклад, якщо першопочаткова спроба дає збій та викликає виняток, рефлексивний процес може проаналізувати невдачу та повторити завдання з уточненим підходом, таким як поліпшений промпт, щоб розв'язати помилку.

## Огляд паттерну обробки винятків та відновлення

Паттерн обробки винятків та відновлення відповідає потребі агентів ШІ в керуванні операційними збоями. Цей паттерн включає передбачення потенційних проблем, таких як помилки інструментів або недоступність послуг, та розробку стратегій для їх пом'якшення. Ці стратегії можуть включати логування помилок, повторні спроби, fallback-механізми, плавну деградацію та повідомлення. Крім того, паттерн підкреслює механізми відновлення, такі як повернення стану назад, діагностика, самокорекція та підвищення, для повернення агентів до стабільної роботи. Впровадження цього паттерну підвищує надійність та стійкість агентів ШІ, дозволяючи їм функціонувати в непередбачуваних середовищах. Приклади практичних застосувань включають чат-боти, що керують помилками бази даних, торгівельні боти, що обробляють фінансові помилки, та агенти розумного дому, що усувають несправності пристроїв. Паттерн гарантує, що агенти можуть продовжувати ефективно працювати, незважаючи на зіткнення з ускладненнями та збоями.

![][image1]

_Рис.1: Ключові компоненти обробки винятків та відновлення для агентів ШІ_

**Виявлення помилок:** Це включає уважне виявлення операційних проблем по мірі їх виникнення. Це може проявлятися як недійсні або неправильно сформатовані вихідні дані інструментів, специфічні помилки API, такі як коди 404 (Не знайдено) або 500 (Помилка сервера), незвично довгий час відповіді від послуг чи API, або невчасні та бессенсовні відповіді, які відхиляються від очікуваних форматів. Крім того, моніторинг іншими агентами або спеціалізованими системами моніторингу може бути впроваджено для більш проактивного виявлення аномалій, дозволяючи системі виявляти потенційні проблеми до їх загострення.

**Обробка помилок:** Після виявлення помилки необхідна ретельно продумана план реагування. Це включає детальне записування деталей помилки в логи для подальшої відладки та аналізу (логування). Повторна спроба дії або запиту, іноді зі злегка скоригованими параметрами, може бути життєздатною стратегією, особливо для тимчасових помилок (повторні спроби). Використання альтернативних стратегій або методів (fallback-механізми) може забезпечити збереження деякої функціональності. Коли повне відновлення не є негайно можливим, агент може підтримувати часткову функціональність, щоб забезпечити хоча б деяку цінність (плавна деградація). Нарешті, оповіщення людських операторів чи інших агентів може бути критично важливим для ситуацій, що вимагають людського втручання або співпраці (повідомлення).

**Відновлення:** Цей етап стосується повернення агента чи системи до стабільного та функціонального стану після помилки. Це може включати скасування останніх змін чи транзакцій для усунення наслідків помилки (повернення стану). Ретельне розслідування причини помилки є життєво важливим для запобігання повторенню. Коригування плану, логіки чи параметрів агента через механізм самокорекції чи процес перепланування може бути необхідним, щоб уникнути тієї ж помилки в майбутньому. У складних чи серйозних випадках делегування проблеми людському оператору чи системі вищого рівня (підвищення) може бути кращим напрямком дій.

Впровадження цього надійного паттерну обробки винятків та відновлення може трансформувати агентів ШІ з хитких та ненадійних систем на стійкі, надійні компоненти, здатні ефективно та стійко працювати в складних та крайньо непередбачуваних середовищах. Це гарантує, що агенти підтримують функціональність, мінімізують час простою та забезпечують плавну та надійну роботу навіть при зіткненні з непередбаченими проблемами.

## Практичні застосування та випадки використання

Обробка винятків та відновлення є критично важливими для будь-якого агента, розгорнутого в реальному сценарії, де ідеальні умови не можуть бути гарантовані.

- **Чат-боти служби підтримки клієнтів:** Якщо чат-бот спробує отримати доступ до бази даних клієнтів, а база даних тимчасово недоступна, він не повинен критично зупинятися. Замість цього він повинен виявити помилку API, інформувати користувача про тимчасову проблему, можливо запропонувати спробувати ще раз пізніше або підвищити запит до людського агента.

- **Автоматизована фінансова торгівля:** Торговий бот, що намагається виконати угоду, може зіткнутися з помилкою "insufficient funds" (недостатньо коштів) або "market closed" (ринок закритий). Він повинен обробляти ці винятки, логуючи помилку, не повторюючи одну й ту ж недійсну угоду кількісно разів, та потенційно повідомляючи користувача чи коригуючи свою стратегію.

- **Автоматизація розумного дому:** Агент, що керує розумним освітленням, може не справитися з увімкненням світла через проблеми з мережею чи несправність пристрою. Він повинен виявити цей збій, можливо повторити спробу, і якщо все ще безуспішно, повідомити користувача, що світло не було увімкнено, та запропонувати ручне втручання.

- **Агенти обробки даних:** Агент, завданням якого є обробка пакету документів, може зіткнутися з пошкодженим файлом. Він повинен пропустити пошкоджений файл, зафіксувати помилку, продовжити обробку інших файлів та повідомити про пропущені файли в кінці, а не зупиняти весь процес.

- **Агенти веб-скрапінгу:** Коли агент веб-скрапінгу зіткнеться з CAPTCHA, змінено структурою веб-сайту чи помилкою сервера (наприклад, 404 Not Found, 503 Service Unavailable), він повинен обробити це коректно. Це може включати паузу, використання проксі або повідомлення про конкретну URL, яку не вдалося обробити.

- **Робототехніка та виробництво:** Роботизована рука, що виконує завдання з'єднання, може не справитися з захопленням компонента через неточність. Вона повинна виявити цей збій (наприклад, через зворотний зв'язок датчиків), спробувати перенастроїтися, повторити захоплення, і якщо проблема зберігається, попередити людського оператора або перейти на інший компонент.

Коротко кажучи, цей паттерн є фундаментальним для створення агентів, які є не тільки інтелектуальними, але й надійними, стійкими та зручними для користувача в умовах складності реального світу.

## Практичний приклад коду (ADK)

Обробка винятків та відновлення є життєво важливими для надійності та стабільності системи. Розглянемо, наприклад, реакцію агента на невдалий виклик інструменту. Такі збої можуть відбуватися через неправильне введення інструменту або проблеми з зовнішньою послугою, від якої залежить інструмент.

```python
from google.adk.agents import Agent, SequentialAgent

# Агент 1: Намагається використовувати основний інструмент. Його фокус вузький та ясний.
primary_handler = Agent(
    name="primary_handler",
    model="gemini-2.0-flash-exp",
    instruction="""
Ваше завдання - отримати точну інформацію про місцезнаходження.
Використовуйте інструмент get_precise_location_info з адресою, надана користувачем.
    """,
    tools=[get_precise_location_info]
)

# Агент 2: Діє як fallback-обробник, перевіряючи стан для прийняття рішення.
fallback_handler = Agent(
    name="fallback_handler",
    model="gemini-2.0-flash-exp",
    instruction="""
Перевірте, чи не вдалося пошуку основного місцезнаходження, подивившись на state["primary_location_failed"].
- Якщо це True, витягніть місто з оригінального запиту користувача та використайте інструмент get_general_area_info.
- Якщо це False, нічого не робіть.
    """,
    tools=[get_general_area_info]
)

# Агент 3: Представляє остаточний результат зі стану.
response_agent = Agent(
    name="response_agent",
    model="gemini-2.0-flash-exp",
    instruction="""
Перегляньте інформацію про місцезнаходження, збережену в state["location_result"].
Представте цю інформацію ясно та стисло користувачу.
Якщо state["location_result"] не існує або порожній, вибачтеся за те, що не вдалося отримати місцезнаходження.
    """,
    tools=[]  # Цей агент тільки розглядає остаточний стан.
)

# SequentialAgent забезпечує виконання обробників у гарантованому порядку.
robust_location_agent = SequentialAgent(
    name="robust_location_agent",
    sub_agents=[primary_handler, fallback_handler, response_agent]
)
```

Цей код визначає надійну систему отримання інформації про місцезнаходження, використовуючи SequentialAgent ADK з трьома підагентами. primary_handler є першим агентом, який намагається отримати точну інформацію про місцезнаходження за допомогою інструменту get_precise_location_info. fallback_handler діє як резервний, перевіряючи, чи не вдалася основна пошук, переглядаючи змінну стану. Якщо основна пошук не вдалася, резервний агент витягує місто з запиту користувача та використовує інструмент get_general_area_info. response_agent є остаточним агентом у послідовності. Він переглядає інформацію про місцезнаходження, збережену в стані. Цей агент призначений для представлення остаточного результату користувачу. Якщо інформація про місцезнаходження не знайдена, він вибачається. SequentialAgent гарантує, що ці три агенти виконуються у попередньо визначеному порядку. Ця структура дозволяє багаторівневий підхід до отримання інформації про місцезнаходження.

## З першого погляду

**Що:** Агенти ШІ, що працюють у реальних середовищах, неминуче зіткнуться з непередбаченими ситуаціями, помилками та системними збоями. Ці порушення можуть варіюватися від збоїв інструментів та проблем з мережею до недійсних даних, що загрожує здатності агента виконувати свої завдання. Без структурованого способу керування цими проблемами агенти можуть бути крихкими, ненадійними та схильними до повного збою при зіткненні з непередбаченими перешкодами. Ця ненадійність ускладнює їх розгортання у критичних або складних додатках, де стабільна продуктивність є суттєвою.

**Чому:** Паттерн обробки винятків та відновлення надає стандартизоване рішення для створення надійних та стійких агентів ШІ. Він озброює їх здатністю передбачити, керувати та відновлюватися після операційних збоїв. Паттерн включає проактивне виявлення помилок, таке як моніторинг вихідних даних інструментів та відповідей API, та реактивні стратегії обробки, такі як логування для діагностики, повторні спроби тимчасових збоїв чи використання fallback-механізмів. Для більш серйозних проблем він визначає протоколи відновлення, включаючи повернення до стабільного стану, самокорекцію шляхом коригування свого плану чи підвищення проблеми до людського оператора. Цей систематичний підхід гарантує, що агенти можуть підтримувати операційну цілісність, вчитися на збоях та надійно функціонувати в непередбачуваних умовах.

**Емпіричне правило:** Використовуйте цей паттерн для будь-якого агента ШІ, розгорнутого в динамічному реальному середовищі, де можливі системні збої, помилки інструментів, проблеми з мережею або непередбачуваний введення даних, та де операційна надійність є ключовою вимогою.

**Візуальне резюме**

![][image2]

_Рис.2: Паттерн обробки винятків_

## Ключові висновки

Основні моменти для запам'ятовування:

- Обробка винятків та відновлення є суттєвими для створення надійних та стабільних агентів.
- Цей паттерн включає виявлення помилок, правильну їх обробку та впровадження стратегій відновлення.
- Виявлення помилок може включати валідацію вихідних даних інструментів, перевірку кодів помилок API та використання таймаутів.
- Стратегії обробки включають логування, повторні спроби, fallback-механізми, плавну деградацію та повідомлення.
- Відновлення зосереджується на повернення до стабільної роботи через діагностику, самокорекцію або підвищення.
- Цей паттерн гарантує, що агенти можуть ефективно працювати навіть у непередбачуваних реальних середовищах.

## Висновок

Цей розділ досліджує паттерн обробки винятків та відновлення, який є суттєвим для розробки надійних та надійних агентів ШІ. Цей паттерн розглядає, як агенти ШІ можуть виявляти та керувати непередбаченими проблемами, впроваджувати відповідні відповіді та відновлюватися до стабільного операційного стану. Розділ обговорює різні аспекти цього паттерну, включаючи виявлення помилок, обробку цих помилок через такі механізми, як логування, повторні спроби та fallback-механізми, а також стратегії, використовувані для відновлення агента чи системи до правильної функціональності. Практичні застосування паттерну обробки винятків та відновлення ілюструються у кількох областях, щоб продемонструвати його актуальність у обробці складностей та потенційних збоїв реального світу. Ці застосування показують, як озброєння агентів ШІ можливостями обробки винятків сприяє їх надійності та адаптивності в динамічних середовищах.

## Список літератури

1. McConnell, S. (2004). _Code Complete (2nd ed.)_. Microsoft Press.
2. Shi, Y., Pei, H., Feng, L., Zhang, Y., & Yao, D. (2024). _Towards Fault Tolerance in Multi-Agent Reinforcement Learning_. arXiv preprint arXiv:2412.00534.
3. O'Neill, V. (2022). _Improving Fault Tolerance and Reliability of Heterogeneous Multi-Agent IoT Systems Using Intelligence Transfer_. Electronics, 11(17), 2724.

[image1]: ../Assets/chapter-12-image1.png
[image2]: ../Assets/chapter-12-image2.png

---

## Навігація

**Назад:** [Розділ 11. Постановка цілей та моніторинг](../Частина%202/Розділ%2011.%20Постановка%20цілей%20та%20моніторинг.md)
**Вперед:** [Розділ 13. Людина в контурі](Розділ%2013.%20Людина%20в%20контурі.md)
